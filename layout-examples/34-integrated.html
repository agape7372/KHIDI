<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>34. Integrated - KHIDI 브리핑</title>
  <script src="https://cdn.tailwindcss.com"></script>
    <style>
    @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
    html { font-size: 17px; }
    body { font-family: 'Pretendard', sans-serif; font-size: 1rem; }
    .panel { height: calc(100vh - 56px); overflow-y: auto; }

  </style>
</head>
<body class="bg-gray-100">
  <!-- Top Header -->
  <header class="bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between sticky top-0 z-10">
    <div class="flex items-center gap-4">
      <a href="index.html" class="text-gray-400 hover:text-gray-600 text-xs">← 목록</a>
      <div class="flex items-center gap-2">
        <span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded">R&D정책</span>
        <span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded">NEW</span>
        <h1 class="font-bold text-gray-900 text-sm">보건의료 R&D 예산 1조원 돌파</h1>
        <a href="https://www.khidi.or.kr/board/view?menuId=MENU00085&linkId=48854687" target="_blank" class="text-blue-500 hover:text-blue-700 text-xs flex items-center gap-1">
          <span>↗</span> 원문
        </a>
        <span class="text-gray-300">|</span>
        <span class="text-gray-400 text-xs">2026.01.21</span>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <!-- 북마크 -->
      <button onclick="toggleBookmark()" id="bookmarkBtn" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-yellow-500 rounded-lg hover:bg-gray-100 text-lg" title="북마크">
        ☆
      </button>
      <!-- 폰트 크기 조절 -->
      <div class="flex items-center gap-1 border border-gray-200 rounded-lg px-2 py-1">
        <button onclick="changeFontSize(-1)" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded text-sm font-bold">A-</button>
        <span class="text-xs text-gray-400 px-1" id="fontSizeDisplay">17</span>
        <button onclick="changeFontSize(1)" class="w-6 h-6 flex items-center justify-center text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded text-sm font-bold">A+</button>
      </div>
      <button class="px-3 py-1.5 bg-gray-900 text-white rounded text-xs">저장</button>
    </div>
  </header>

  <div class="flex">
    <!-- Left Sidebar: 학습 모드 -->
    <aside class="w-56 bg-white border-r border-gray-200 panel flex flex-col" style="font-size: 13px;">
      <div class="p-4 border-b border-gray-100">
        <div class="flex items-center gap-2">
          <span class="px-2 py-0.5 bg-indigo-100 text-indigo-700 text-xs rounded font-medium">📚 학습모드</span>
        </div>
        <h2 class="font-bold text-gray-900 mt-2 text-sm">R&D 예산 1조 돌파</h2>
      </div>

      <!-- Progress -->
      <div class="px-4 py-3 border-b border-gray-100">
        <div class="flex justify-between text-xs mb-2">
          <span class="text-gray-600">학습 진도</span>
          <span class="font-bold text-indigo-600">4/6</span>
        </div>
        <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
          <div class="h-full bg-indigo-500 rounded-full transition-all" style="width: 66%"></div>
        </div>
      </div>

      <!-- Study Checklist -->
      <div class="flex-1 p-4 overflow-y-auto">
        <div class="text-[10px] text-gray-400 font-medium mb-2">학습 체크리스트</div>
        <div class="space-y-2">
          <label class="flex items-center gap-2 p-2 rounded-lg bg-green-50 border border-green-200 cursor-pointer">
            <input type="checkbox" checked class="accent-green-500">
            <span class="text-xs text-green-800">핵심 수치 암기</span>
          </label>
          <label class="flex items-center gap-2 p-2 rounded-lg bg-green-50 border border-green-200 cursor-pointer">
            <input type="checkbox" checked class="accent-green-500">
            <span class="text-xs text-green-800">현황 분석 이해</span>
          </label>
          <label class="flex items-center gap-2 p-2 rounded-lg bg-green-50 border border-green-200 cursor-pointer">
            <input type="checkbox" checked class="accent-green-500">
            <span class="text-xs text-green-800">문제점 파악</span>
          </label>
          <label class="flex items-center gap-2 p-2 rounded-lg bg-green-50 border border-green-200 cursor-pointer">
            <input type="checkbox" checked class="accent-green-500">
            <span class="text-xs text-green-800">해결방안 숙지</span>
          </label>
          <label class="flex items-center gap-2 p-2 rounded-lg bg-gray-50 border border-gray-200 cursor-pointer">
            <input type="checkbox" class="accent-indigo-500">
            <span class="text-xs text-gray-600">기획안 템플릿 연습</span>
          </label>
          <label class="flex items-center gap-2 p-2 rounded-lg bg-gray-50 border border-gray-200 cursor-pointer">
            <input type="checkbox" class="accent-indigo-500">
            <span class="text-xs text-gray-600">모의 답안 작성</span>
          </label>
        </div>
      </div>

      <!-- Actions -->
      <div class="p-4 border-t border-gray-100">
        <button onclick="openModal()" class="w-full px-3 py-2 bg-indigo-600 text-white rounded-lg text-xs hover:bg-indigo-700 mb-2">
          🎯 모의 테스트
        </button>
        <button class="w-full px-3 py-1.5 bg-gray-100 text-gray-700 rounded text-xs hover:bg-gray-200">
          📎 원문 보기
        </button>
      </div>
    </aside>

    <!-- Center Panel: 브리핑 내용 -->
    <div class="flex-1 panel bg-white border-r border-gray-200 p-5 content-area">
      <div class="max-w-2xl mx-auto">
        <div class="flex items-center gap-2 mb-4">
          <span class="w-6 h-6 bg-blue-500 text-white rounded flex items-center justify-center text-xs">📄</span>
          <h2 class="font-bold text-gray-900">브리핑 내용</h2>
        </div>

        <!-- 핵심 수치 -->
        <div class="grid grid-cols-3 gap-3 mb-5">
          <div class="bg-blue-50 rounded-xl p-4 text-center">
            <div class="text-xl font-bold text-blue-700">1조600억</div>
            <div class="text-[10px] text-gray-500 mt-1">총 예산</div>
          </div>
          <div class="bg-green-50 rounded-xl p-4 text-center">
            <div class="text-xl font-bold text-green-600">+23%</div>
            <div class="text-[10px] text-gray-500 mt-1">증가율</div>
          </div>
          <div class="bg-violet-50 rounded-xl p-4 text-center">
            <div class="text-xl font-bold text-violet-600">3개</div>
            <div class="text-[10px] text-gray-500 mt-1">중점 분야</div>
          </div>
        </div>

        <!-- 현황 분석 -->
        <div class="mb-5">
          <h3 class="font-bold text-gray-900 text-sm mb-3 flex items-center gap-2">
            <span class="text-blue-500">📋</span> 현황 분석
          </h3>
          <div class="space-y-3">
            <div class="flex gap-3 p-3 bg-blue-50 rounded-xl">
              <span class="w-8 h-8 bg-blue-500 text-white rounded-lg flex items-center justify-center font-bold text-sm shrink-0">01</span>
              <div>
                <div class="font-semibold text-gray-900">예산 규모</div>
                <p class="text-gray-600 text-sm mt-1">1조 600억 원으로 전년 대비 23% 증가하여 역대 최대 규모 달성. 보건의료 R&D에 대한 정부의 전략적 투자 의지를 반영함.</p>
              </div>
            </div>
            <div class="flex gap-3 p-3 bg-blue-50 rounded-xl">
              <span class="w-8 h-8 bg-blue-500 text-white rounded-lg flex items-center justify-center font-bold text-sm shrink-0">02</span>
              <div>
                <div class="font-semibold text-gray-900">중점 분야</div>
                <p class="text-gray-600 text-sm mt-1">디지털헬스케어, 바이오의약품, 필수의료 3개 분야에 집중 투자. 4차 산업혁명 시대의 보건산업 경쟁력 강화 목표.</p>
              </div>
            </div>
            <div class="flex gap-3 p-3 bg-blue-50 rounded-xl">
              <span class="w-8 h-8 bg-blue-500 text-white rounded-lg flex items-center justify-center font-bold text-sm shrink-0">03</span>
              <div>
                <div class="font-semibold text-gray-900">정책 방향</div>
                <p class="text-gray-600 text-sm mt-1">기술 자립화 및 글로벌 경쟁력 강화를 통한 보건산업 생태계 구축. 수입 의존도 감소 및 수출 확대 추진.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- 문제점 -->
        <div class="mb-5">
          <h3 class="font-bold text-gray-900 text-sm mb-3 flex items-center gap-2">
            <span class="text-amber-500">⚠️</span> 문제점
          </h3>
          <div class="grid grid-cols-3 gap-3">
            <div class="bg-amber-50 rounded-xl p-4 border border-amber-200">
              <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center mb-2">
                <span class="text-amber-600 text-lg">👥</span>
              </div>
              <div class="font-semibold text-amber-800 mb-1">인력 부족</div>
              <p class="text-amber-700 text-xs leading-relaxed">R&D 전문인력 수급 불균형이 심화되고 있습니다. 특히 AI·바이오 융합 분야 인재가 절대적으로 부족합니다.</p>
            </div>
            <div class="bg-amber-50 rounded-xl p-4 border border-amber-200">
              <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center mb-2">
                <span class="text-amber-600 text-lg">🔒</span>
              </div>
              <div class="font-semibold text-amber-800 mb-1">규제 장벽</div>
              <p class="text-amber-700 text-xs leading-relaxed">신기술에 대한 인허가 체계 정비가 시급합니다. 현행 규제 체계가 혁신 속도를 따라가지 못하고 있습니다.</p>
            </div>
            <div class="bg-amber-50 rounded-xl p-4 border border-amber-200">
              <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center mb-2">
                <span class="text-amber-600 text-lg">🌍</span>
              </div>
              <div class="font-semibold text-amber-800 mb-1">글로벌 경쟁</div>
              <p class="text-amber-700 text-xs leading-relaxed">미국, 중국 등 주요국 대비 투자 규모가 여전히 부족합니다. 기술 격차 해소를 위한 추가 투자가 필요합니다.</p>
            </div>
          </div>
        </div>

        <!-- 해결방안 -->
        <div class="mb-5">
          <h3 class="font-bold text-gray-900 text-sm mb-3 flex items-center gap-2">
            <span class="text-green-500">💡</span> 해결방안
          </h3>
          <div class="space-y-3">
            <div class="border-l-4 border-green-500 bg-green-50 rounded-r-xl p-4">
              <div class="flex items-center gap-2 mb-2">
                <span class="px-2 py-0.5 bg-green-500 text-white text-xs font-bold rounded">단기</span>
                <span class="font-semibold text-gray-900">산학협력 확대</span>
              </div>
              <p class="text-gray-600 text-sm">규제 샌드박스를 활용하여 신기술 실증 기회 확대. 대학·연구소와 기업 간 공동 R&D 프로젝트 추진.</p>
            </div>
            <div class="border-l-4 border-green-500 bg-green-50 rounded-r-xl p-4">
              <div class="flex items-center gap-2 mb-2">
                <span class="px-2 py-0.5 bg-green-500 text-white text-xs font-bold rounded">중기</span>
                <span class="font-semibold text-gray-900">인력양성 체계 구축</span>
              </div>
              <p class="text-gray-600 text-sm">인허가 절차 간소화 및 전문인력 양성 프로그램 확대. 해외 우수 인재 유치를 위한 지원제도 마련.</p>
            </div>
            <div class="border-l-4 border-green-500 bg-green-50 rounded-r-xl p-4">
              <div class="flex items-center gap-2 mb-2">
                <span class="px-2 py-0.5 bg-green-500 text-white text-xs font-bold rounded">장기</span>
                <span class="font-semibold text-gray-900">생태계 자립화</span>
              </div>
              <p class="text-gray-600 text-sm">글로벌 경쟁력을 갖춘 보건산업 생태계 구축. 핵심 기술 국산화 및 해외 시장 진출 기반 마련.</p>
            </div>
          </div>
        </div>

        <!-- 기대효과 -->
        <div>
          <h3 class="font-bold text-gray-900 text-sm mb-3 flex items-center gap-2">
            <span class="text-violet-500">📈</span> 2030 기대효과
          </h3>
          <div class="bg-white rounded-xl border border-gray-200 p-4">
            <div class="space-y-4">
              <div>
                <div class="flex justify-between mb-2">
                  <span class="text-sm text-gray-700">디지털헬스 시장 규모</span>
                  <span class="font-bold text-violet-600">30조 원</span>
                </div>
                <div class="h-3 bg-gray-100 rounded-full overflow-hidden">
                  <div class="h-full bg-violet-500 rounded-full" style="width:90%"></div>
                </div>
              </div>
              <div>
                <div class="flex justify-between mb-2">
                  <span class="text-sm text-gray-700">바이오 수출액</span>
                  <span class="font-bold text-blue-600">$100억</span>
                </div>
                <div class="h-3 bg-gray-100 rounded-full overflow-hidden">
                  <div class="h-full bg-blue-500 rounded-full" style="width:70%"></div>
                </div>
              </div>
              <div>
                <div class="flex justify-between mb-2">
                  <span class="text-sm text-gray-700">일자리 창출</span>
                  <span class="font-bold text-emerald-600">50만 개</span>
                </div>
                <div class="h-3 bg-gray-100 rounded-full overflow-hidden">
                  <div class="h-full bg-emerald-500 rounded-full" style="width:60%"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Panel: 답안 작성 가이드 -->
    <div class="flex-1 panel bg-purple-50 p-5 content-area">
      <div class="max-w-2xl mx-auto">
        <div class="flex items-center gap-2 mb-4">
          <span class="w-6 h-6 bg-purple-500 text-white rounded flex items-center justify-center text-sm">✍️</span>
          <h2 class="font-bold text-purple-900">답안 작성 가이드</h2>
        </div>

        <!-- 기획안 템플릿 -->
        <div class="bg-white rounded-xl border border-purple-200 p-4 mb-4">
          <h3 class="font-bold text-purple-800 text-sm mb-3 flex items-center gap-2">
            <span>★</span> 기획안 템플릿
            <span class="px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded ml-auto">6개 항목</span>
          </h3>
          <div class="space-y-3 text-sm">
            <div class="border-l-4 border-purple-400 pl-3 py-2 bg-purple-50 rounded-r-lg">
              <div class="font-bold text-purple-700">◎ 사업 개요</div>
              <p class="text-gray-600 mt-1">○ 사업명: 보건의료 R&D 투자 확대를 통한 디지털헬스케어 산업 육성 사업</p>
            </div>
            <div class="border-l-4 border-purple-400 pl-3 py-2 bg-purple-50 rounded-r-lg">
              <div class="font-bold text-purple-700">◎ 추진 배경</div>
              <ul class="text-gray-600 mt-1 space-y-1">
                <li>○ 보건의료 R&D 예산 1조원 돌파, 역대 최대 규모</li>
                <li>○ 디지털헬스케어가 미래 핵심 산업으로 부상</li>
                <li>○ 글로벌 경쟁 심화로 기술 자립화 필요성 증대</li>
              </ul>
            </div>
            <div class="border-l-4 border-purple-400 pl-3 py-2 bg-purple-50 rounded-r-lg">
              <div class="font-bold text-purple-700">◎ 추진 목적</div>
              <ul class="text-gray-600 mt-1 space-y-1">
                <li>○ 2030년 디지털헬스 시장 30조 원 달성</li>
                <li>○ 바이오 수출 $100억, 일자리 50만 창출</li>
              </ul>
            </div>
            <div class="border-l-4 border-amber-400 pl-3 py-2 bg-amber-50 rounded-r-lg">
              <div class="font-bold text-amber-700">◎ 문제점</div>
              <ul class="text-gray-600 mt-1 space-y-1">
                <li>○ R&D 전문인력 수급 불균형</li>
                <li>○ 신기술 인허가 체계 정비 미흡</li>
                <li>○ 주요국 대비 투자 규모 부족</li>
              </ul>
            </div>
            <div class="border-l-4 border-green-400 pl-3 py-2 bg-green-50 rounded-r-lg">
              <div class="font-bold text-green-700">◎ 해결방안</div>
              <ul class="text-gray-600 mt-1 space-y-1">
                <li>○ 산학협력 확대 및 규제 샌드박스 활용</li>
                <li>○ 전문인력 양성 체계 구축</li>
                <li>○ 글로벌 경쟁력 강화를 위한 생태계 자립화</li>
              </ul>
            </div>
            <div class="border-l-4 border-blue-400 pl-3 py-2 bg-blue-50 rounded-r-lg">
              <div class="font-bold text-blue-700">◎ 사업 내용</div>
              <ul class="text-gray-600 mt-1 space-y-1">
                <li>○ 디지털헬스케어·바이오의약품·필수의료 3개 분야 집중 투자</li>
                <li>○ 해외 연구기관과의 협력 네트워크 구축</li>
                <li>○ 인력양성 가이드라인 수립 및 실습시설 확충</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- 문제점/해결방안 템플릿 -->
        <div class="bg-white rounded-xl border border-purple-200 p-4 mb-4">
          <h3 class="font-bold text-purple-800 text-sm mb-3 flex items-center gap-2">
            <span>★</span> 문제점 및 해결방안 템플릿
            <span class="px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded ml-auto">3개 항목</span>
          </h3>
          <div class="space-y-3 text-sm">
            <div class="border-l-4 border-blue-400 pl-3 py-2 bg-blue-50 rounded-r-lg">
              <div class="font-bold text-blue-700">◎ 현황</div>
              <ul class="text-gray-600 mt-1 space-y-1">
                <li>- 보건의료 R&D 예산 1조 600억 원 (23% 증가)</li>
                <li>- 디지털헬스케어, 바이오, 필수의료 중점 투자</li>
                <li>- 기술 자립화 및 글로벌 경쟁력 강화 추진</li>
              </ul>
            </div>
            <div class="border-l-4 border-amber-400 pl-3 py-2 bg-amber-50 rounded-r-lg">
              <div class="font-bold text-amber-700">◎ 문제점</div>
              <ul class="text-gray-600 mt-1 space-y-1">
                <li>- R&D 전문인력 수급 불균형</li>
                <li>- 인허가 체계 정비 지연</li>
                <li>- 주요국 대비 투자 규모 부족</li>
              </ul>
            </div>
            <div class="border-l-4 border-green-400 pl-3 py-2 bg-green-50 rounded-r-lg">
              <div class="font-bold text-green-700">◎ 해결방안</div>
              <ul class="text-gray-600 mt-1 space-y-1">
                <li><span class="text-green-600 font-medium">○ 단기:</span> 산학협력, 규제 샌드박스</li>
                <li><span class="text-green-600 font-medium">○ 중기:</span> 인력양성, 인허가 간소화</li>
                <li><span class="text-green-600 font-medium">○ 장기:</span> 생태계 자립, 글로벌 경쟁력</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- 인바스켓 예상 포인트 -->
        <div class="bg-white rounded-xl border border-purple-200 p-4">
          <h3 class="font-bold text-purple-800 text-sm mb-3 flex items-center gap-2">
            <span>💡</span> 인바스켓 예상 포인트
          </h3>
          <div class="space-y-2 text-sm">
            <div class="flex gap-3 p-3 bg-purple-50 rounded-lg">
              <span class="w-6 h-6 bg-purple-500 text-white rounded text-xs flex items-center justify-center shrink-0">1</span>
              <div>
                <div class="font-semibold text-purple-800">예산 배분 우선순위</div>
                <p class="text-gray-600 mt-0.5">디지털헬스 vs 바이오 투자 비중 논술</p>
              </div>
            </div>
            <div class="flex gap-3 p-3 bg-purple-50 rounded-lg">
              <span class="w-6 h-6 bg-purple-500 text-white rounded text-xs flex items-center justify-center shrink-0">2</span>
              <div>
                <div class="font-semibold text-purple-800">부처간 협력 방안</div>
                <p class="text-gray-600 mt-0.5">복지부-산업부-과기부 협력 체계</p>
              </div>
            </div>
            <div class="flex gap-3 p-3 bg-purple-50 rounded-lg">
              <span class="w-6 h-6 bg-purple-500 text-white rounded text-xs flex items-center justify-center shrink-0">3</span>
              <div>
                <div class="font-semibold text-purple-800">성과 지표 설정</div>
                <p class="text-gray-600 mt-0.5">R&D 효과성 측정 KPI 설정</p>
              </div>
            </div>
          </div>
        </div>

        <!-- 작성 팁 -->
        <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
          <div class="font-bold text-yellow-800 text-sm mb-1">💡 작성 팁</div>
          <ul class="text-yellow-700 text-sm space-y-1">
            <li>• 시간 배분: 4문항을 모두 작성하려면 효율적인 시간 관리 필수</li>
            <li>• 구조화: 항목별로 명확하게 구분하여 작성</li>
            <li>• 구체성: 추상적 표현보다 구체적인 방안 제시</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- 플로팅 텍스트 툴바 -->
  <div id="textToolbar" class="fixed hidden bg-gray-900 text-white rounded-lg shadow-xl px-1 py-1 flex items-center gap-1 z-50" style="transform: translateX(-50%);">
    <button onclick="applyHighlight('#fef08a')" class="w-6 h-6 rounded hover:scale-110 transition-transform" style="background:#fef08a;" title="노랑"></button>
    <button onclick="applyHighlight('#bbf7d0')" class="w-6 h-6 rounded hover:scale-110 transition-transform" style="background:#bbf7d0;" title="초록"></button>
    <button onclick="applyHighlight('#bfdbfe')" class="w-6 h-6 rounded hover:scale-110 transition-transform" style="background:#bfdbfe;" title="파랑"></button>
    <button onclick="applyHighlight('#fbcfe8')" class="w-6 h-6 rounded hover:scale-110 transition-transform" style="background:#fbcfe8;" title="분홍"></button>
    <button onclick="applyHighlight('#fed7aa')" class="w-6 h-6 rounded hover:scale-110 transition-transform" style="background:#fed7aa;" title="주황"></button>
    <div class="w-px h-5 bg-gray-600 mx-1"></div>
    <button onclick="applyFormat('bold')" class="px-2 py-1 hover:bg-gray-700 rounded text-sm font-bold" title="굵게">B</button>
    <button onclick="applyFormat('italic')" class="px-2 py-1 hover:bg-gray-700 rounded text-sm italic" title="기울임">I</button>
    <div class="w-px h-5 bg-gray-600 mx-1"></div>
    <button onclick="applyFormat('remove')" class="px-2 py-1 hover:bg-gray-700 rounded text-xs text-gray-400" title="서식 제거">✕</button>
  </div>

  <!-- 불러오기 모달 -->
  <div id="loadModal" class="fixed inset-0 bg-black/50 z-[60] hidden items-center justify-center">
    <div class="bg-white rounded-xl w-[500px] max-h-[70vh] flex flex-col shadow-2xl">
      <div class="flex items-center justify-between px-5 py-4 border-b border-gray-200">
        <h3 class="font-bold text-gray-900">📂 저장된 답안 불러오기</h3>
        <button onclick="closeLoadModal()" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
      </div>
      <div class="flex-1 overflow-y-auto p-4" id="savedList">
        <!-- 저장된 목록이 여기에 표시됨 -->
      </div>
      <div class="px-5 py-3 border-t border-gray-200 flex justify-end gap-2">
        <button onclick="clearAllSaved()" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg text-sm hover:bg-red-200">🗑 전체 삭제</button>
        <button onclick="closeLoadModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300">닫기</button>
      </div>
    </div>
  </div>

  <!-- 모의 테스트 모달 -->
  <div id="testModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-2xl w-[90vw] h-[90vh] flex flex-col shadow-2xl">
      <!-- 모달 헤더 -->
      <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
        <div class="flex items-center gap-4">
          <h2 class="font-bold text-lg text-gray-900">✍️ 모의 답안 작성</h2>
        </div>
        <div class="flex items-center gap-3">
          <!-- 타이머 -->
          <div class="flex items-center gap-2 rounded-lg px-3 py-2 transition-colors" id="timerContainer" style="background: #f3f4f6;">
            <!-- 모드 전환 -->
            <div class="flex bg-gray-200 rounded p-0.5">
              <button onclick="setTimerMode('stopwatch')" id="modeStopwatch" class="px-2 py-1 text-xs rounded bg-white text-gray-900 font-medium">스톱워치</button>
              <button onclick="setTimerMode('countdown')" id="modeCountdown" class="px-2 py-1 text-xs rounded text-gray-500">카운트다운</button>
            </div>
            <!-- 프리셋 (카운트다운 모드) -->
            <div id="presetButtons" class="hidden flex gap-1">
              <button onclick="setPreset(30)" class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200">30분</button>
              <button onclick="setPreset(60)" class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200">60분</button>
              <button onclick="setPreset(90)" class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200">90분</button>
              <input type="number" id="customMinutes" placeholder="분" min="1" max="180" class="w-12 px-2 py-1 border border-gray-300 rounded text-xs text-center" onchange="setPreset(this.value)">
            </div>
            <!-- 스톱워치 모드용 공간 채우기 -->
            <div id="stopwatchSpacer" class="flex gap-1" style="visibility: hidden;">
              <span class="px-2 py-1 text-xs">30분</span>
              <span class="px-2 py-1 text-xs">60분</span>
              <span class="px-2 py-1 text-xs">90분</span>
              <span class="w-12 px-2 py-1 text-xs"></span>
            </div>
            <!-- 시간 표시 -->
            <div class="flex items-center gap-1">
              <span class="text-2xl font-mono font-bold" id="timerDisplay">00:00:00</span>
              <span id="timerLabel" class="text-xs text-gray-500 hidden">/ 00:00:00</span>
              <span id="timerLabelSpacer" class="text-xs" style="visibility: hidden;">/ 00:00:00</span>
            </div>
            <!-- 진행바 (카운트다운 모드) -->
            <div id="progressBar" class="hidden w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
              <div id="progressFill" class="h-full bg-green-500 transition-all" style="width: 100%"></div>
            </div>
            <!-- 스톱워치 모드용 진행바 공간 -->
            <div id="progressBarSpacer" class="w-24 h-2" style="visibility: hidden;"></div>
            <!-- 컨트롤 -->
            <div class="flex gap-1">
              <button onclick="startTimer()" id="btnStart" class="px-2 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600">▶</button>
              <button onclick="pauseTimer()" id="btnPause" class="px-2 py-1 bg-yellow-500 text-white rounded text-xs hover:bg-yellow-600 hidden">⏸</button>
              <button onclick="resetTimer()" class="px-2 py-1 bg-gray-500 text-white rounded text-xs hover:bg-gray-600">↺</button>
            </div>
            <!-- 알림 토글 -->
            <label class="flex items-center gap-1 cursor-pointer">
              <input type="checkbox" id="soundEnabled" checked class="accent-indigo-500">
              <span class="text-xs text-gray-500">🔔</span>
            </label>
          </div>
          <span id="autoSaveIndicator" class="text-xs text-green-500 opacity-0 transition-opacity">자동저장됨</span>
          <button onclick="saveAnswer()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700">💾 저장</button>
          <button onclick="exportWord()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">📝 Word</button>
          <button onclick="openLoadModal()" class="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm hover:bg-purple-700">📂 불러오기</button>
          <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300">✕ 닫기</button>
        </div>
      </div>

      <!-- 모달 본문: 좌우 분할 -->
      <div class="flex-1 flex overflow-hidden">
        <!-- 좌: 기획안 템플릿 -->
        <div id="template-plan" class="w-1/2 overflow-y-auto p-5 border-r border-gray-200">
          <h3 class="font-bold text-purple-800 mb-4 flex items-center gap-2">
            <span class="w-6 h-6 bg-purple-500 text-white rounded flex items-center justify-center text-xs">★</span>
            기획안 템플릿
            <span class="px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded ml-auto">6개 항목</span>
          </h3>
          <div class="space-y-3">
            <div class="border-l-4 border-purple-400 bg-purple-50 rounded-r-xl p-3">
              <div class="flex justify-between items-center mb-2">
                <label class="font-bold text-purple-700 text-sm">◎ 사업 개요</label>
                <span class="char-counter text-xs text-gray-400">0자 / 0줄</span>
              </div>
              <textarea class="w-full h-16 p-2 border border-gray-300 rounded-lg text-sm resize-none auto-bullet" data-bullet="○" placeholder="○ 사업명: ..." oninput="updateCharCount(this)"></textarea>
            </div>
            <div class="border-l-4 border-purple-400 bg-purple-50 rounded-r-xl p-3">
              <div class="flex justify-between items-center mb-2">
                <label class="font-bold text-purple-700 text-sm">◎ 추진 배경</label>
                <span class="char-counter text-xs text-gray-400">0자 / 0줄</span>
              </div>
              <textarea class="w-full h-20 p-2 border border-gray-300 rounded-lg text-sm resize-none auto-bullet" data-bullet="○" placeholder="Enter=줄바꿈(○) | Tab=소항목(•)" oninput="updateCharCount(this)"></textarea>
            </div>
            <div class="border-l-4 border-purple-400 bg-purple-50 rounded-r-xl p-3">
              <div class="flex justify-between items-center mb-2">
                <label class="font-bold text-purple-700 text-sm">◎ 추진 목적</label>
                <span class="char-counter text-xs text-gray-400">0자 / 0줄</span>
              </div>
              <textarea class="w-full h-20 p-2 border border-gray-300 rounded-lg text-sm resize-none auto-bullet" data-bullet="○" placeholder="Enter=줄바꿈(○) | Tab=소항목(•)" oninput="updateCharCount(this)"></textarea>
            </div>
            <div class="border-l-4 border-amber-400 bg-amber-50 rounded-r-xl p-3">
              <div class="flex justify-between items-center mb-2">
                <label class="font-bold text-amber-700 text-sm">◎ 문제점</label>
                <span class="char-counter text-xs text-gray-400">0자 / 0줄</span>
              </div>
              <textarea class="w-full h-20 p-2 border border-gray-300 rounded-lg text-sm resize-none auto-bullet" data-bullet="○" placeholder="Enter=줄바꿈(○) | Tab=소항목(•)" oninput="updateCharCount(this)"></textarea>
            </div>
            <div class="border-l-4 border-green-400 bg-green-50 rounded-r-xl p-3">
              <div class="flex justify-between items-center mb-2">
                <label class="font-bold text-green-700 text-sm">◎ 해결방안</label>
                <span class="char-counter text-xs text-gray-400">0자 / 0줄</span>
              </div>
              <textarea class="w-full h-20 p-2 border border-gray-300 rounded-lg text-sm resize-none auto-bullet" data-bullet="○" placeholder="Enter=줄바꿈(○) | Tab=소항목(•)" oninput="updateCharCount(this)"></textarea>
            </div>
            <div class="border-l-4 border-blue-400 bg-blue-50 rounded-r-xl p-3">
              <div class="flex justify-between items-center mb-2">
                <label class="font-bold text-blue-700 text-sm">◎ 사업 내용</label>
                <span class="char-counter text-xs text-gray-400">0자 / 0줄</span>
              </div>
              <textarea class="w-full h-20 p-2 border border-gray-300 rounded-lg text-sm resize-none auto-bullet" data-bullet="○" placeholder="Enter=줄바꿈(○) | Tab=소항목(•)" oninput="updateCharCount(this)"></textarea>
            </div>
          </div>
        </div>

        <!-- 우: 문제점/해결방안 템플릿 -->
        <div id="template-problem" class="w-1/2 overflow-y-auto p-5 bg-slate-50">
          <h3 class="font-bold text-blue-800 mb-4 flex items-center gap-2">
            <span class="w-6 h-6 bg-blue-500 text-white rounded flex items-center justify-center text-xs">★</span>
            문제점 및 해결방안 템플릿
            <span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded ml-auto">3개 항목</span>
          </h3>
          <div class="space-y-3">
            <div class="border-l-4 border-blue-400 bg-blue-50 rounded-r-xl p-3">
              <div class="flex justify-between items-center mb-2">
                <label class="font-bold text-blue-700 text-sm">◎ 현황</label>
                <span class="char-counter text-xs text-gray-400">0자 / 0줄</span>
              </div>
              <textarea class="w-full h-28 p-2 border border-gray-300 rounded-lg text-sm resize-none auto-bullet" data-bullet="-" placeholder="Enter=줄바꿈(-) | Tab=소항목(•)" oninput="updateCharCount(this)"></textarea>
            </div>
            <div class="border-l-4 border-amber-400 bg-amber-50 rounded-r-xl p-3">
              <div class="flex justify-between items-center mb-2">
                <label class="font-bold text-amber-700 text-sm">◎ 문제점</label>
                <span class="char-counter text-xs text-gray-400">0자 / 0줄</span>
              </div>
              <textarea class="w-full h-28 p-2 border border-gray-300 rounded-lg text-sm resize-none auto-bullet" data-bullet="-" placeholder="Enter=줄바꿈(-) | Tab=소항목(•)" oninput="updateCharCount(this)"></textarea>
            </div>
            <div class="border-l-4 border-green-400 bg-green-50 rounded-r-xl p-3">
              <div class="flex justify-between items-center mb-2">
                <label class="font-bold text-green-700 text-sm">◎ 해결방안</label>
                <span class="char-counter text-xs text-gray-400">0자 / 0줄</span>
              </div>
              <textarea class="w-full h-36 p-2 border border-gray-300 rounded-lg text-sm resize-none auto-bullet" data-bullet="○" placeholder="○ 단기: / ○ 중기: / ○ 장기:" oninput="updateCharCount(this)"></textarea>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentFontSize = 17;
    const minFontSize = 10;
    const maxFontSize = 22;

    function changeFontSize(delta) {
      currentFontSize = Math.min(maxFontSize, Math.max(minFontSize, currentFontSize + delta));
      document.documentElement.style.fontSize = currentFontSize + 'px';
      document.getElementById('fontSizeDisplay').textContent = currentFontSize;
    }

    // 북마크 기능
    const currentBriefingId = 'briefing_rnd_budget'; // 현재 브리핑 ID (실제로는 동적으로 설정)

    function toggleBookmark() {
      const bookmarks = JSON.parse(localStorage.getItem('briefing_bookmarks') || '[]');
      const btn = document.getElementById('bookmarkBtn');
      const idx = bookmarks.indexOf(currentBriefingId);

      if (idx > -1) {
        bookmarks.splice(idx, 1);
        btn.textContent = '☆';
        btn.classList.remove('text-yellow-500');
        btn.classList.add('text-gray-400');
      } else {
        bookmarks.push(currentBriefingId);
        btn.textContent = '★';
        btn.classList.add('text-yellow-500');
        btn.classList.remove('text-gray-400');
      }

      localStorage.setItem('briefing_bookmarks', JSON.stringify(bookmarks));
    }

    // 북마크 상태 초기화
    function initBookmark() {
      const bookmarks = JSON.parse(localStorage.getItem('briefing_bookmarks') || '[]');
      const btn = document.getElementById('bookmarkBtn');
      if (bookmarks.includes(currentBriefingId)) {
        btn.textContent = '★';
        btn.classList.add('text-yellow-500');
        btn.classList.remove('text-gray-400');
      }
    }

    document.addEventListener('DOMContentLoaded', initBookmark);

    // 모달 제어
    function openModal() {
      document.getElementById('testModal').classList.remove('hidden');
      document.getElementById('testModal').classList.add('flex');
      startAutoSave();
      loadAutoSave();
    }

    function closeModal() {
      document.getElementById('testModal').classList.add('hidden');
      document.getElementById('testModal').classList.remove('flex');
      stopAutoSave();
    }

    // 타이머
    let timerInterval = null;
    let timerSeconds = 0;
    let timerMode = 'stopwatch'; // 'stopwatch' or 'countdown'
    let countdownTotal = 0; // 카운트다운 총 시간
    let countdownRemaining = 0; // 카운트다운 남은 시간

    function formatTime(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
    }

    function updateTimerDisplay() {
      const display = document.getElementById('timerDisplay');
      const container = document.getElementById('timerContainer');
      const progressFill = document.getElementById('progressFill');

      if (timerMode === 'stopwatch') {
        display.textContent = formatTime(timerSeconds);
        container.style.background = '#f3f4f6';
        display.style.color = '#111827';
      } else {
        display.textContent = formatTime(countdownRemaining);

        // 진행바 업데이트
        const progress = countdownTotal > 0 ? (countdownRemaining / countdownTotal) * 100 : 0;
        progressFill.style.width = progress + '%';

        // 시간에 따른 색상 변경
        if (countdownRemaining <= 0) {
          container.style.background = '#fef2f2';
          display.style.color = '#dc2626';
          progressFill.style.background = '#dc2626';
        } else if (countdownRemaining <= 300) { // 5분 이하
          container.style.background = '#fef2f2';
          display.style.color = '#dc2626';
          progressFill.style.background = '#dc2626';
        } else if (countdownRemaining <= 600) { // 10분 이하
          container.style.background = '#fffbeb';
          display.style.color = '#d97706';
          progressFill.style.background = '#f59e0b';
        } else {
          container.style.background = '#f0fdf4';
          display.style.color = '#16a34a';
          progressFill.style.background = '#22c55e';
        }
      }
    }

    function setTimerMode(mode) {
      timerMode = mode;
      pauseTimer();

      const modeStopwatch = document.getElementById('modeStopwatch');
      const modeCountdown = document.getElementById('modeCountdown');
      const presetButtons = document.getElementById('presetButtons');
      const timerLabel = document.getElementById('timerLabel');
      const progressBar = document.getElementById('progressBar');
      const stopwatchSpacer = document.getElementById('stopwatchSpacer');
      const progressBarSpacer = document.getElementById('progressBarSpacer');
      const timerLabelSpacer = document.getElementById('timerLabelSpacer');

      if (mode === 'stopwatch') {
        modeStopwatch.classList.add('bg-white', 'text-gray-900', 'font-medium');
        modeStopwatch.classList.remove('text-gray-500');
        modeCountdown.classList.remove('bg-white', 'text-gray-900', 'font-medium');
        modeCountdown.classList.add('text-gray-500');
        presetButtons.classList.add('hidden');
        timerLabel.classList.add('hidden');
        progressBar.classList.add('hidden');
        stopwatchSpacer.style.display = 'flex';
        progressBarSpacer.style.display = 'block';
        timerLabelSpacer.style.display = 'inline';
        timerSeconds = 0;
      } else {
        modeCountdown.classList.add('bg-white', 'text-gray-900', 'font-medium');
        modeCountdown.classList.remove('text-gray-500');
        modeStopwatch.classList.remove('bg-white', 'text-gray-900', 'font-medium');
        modeStopwatch.classList.add('text-gray-500');
        presetButtons.classList.remove('hidden');
        timerLabel.classList.remove('hidden');
        progressBar.classList.remove('hidden');
        stopwatchSpacer.style.display = 'none';
        progressBarSpacer.style.display = 'none';
        timerLabelSpacer.style.display = 'none';
        setPreset(60); // 기본 60분
      }
      updateTimerDisplay();
    }

    function setPreset(minutes) {
      minutes = parseInt(minutes) || 60;
      countdownTotal = minutes * 60;
      countdownRemaining = countdownTotal;
      document.getElementById('timerLabel').textContent = '/ ' + formatTime(countdownTotal);
      document.getElementById('progressFill').style.width = '100%';
      updateTimerDisplay();
    }

    function startTimer() {
      if (timerInterval) return;

      document.getElementById('btnStart').classList.add('hidden');
      document.getElementById('btnPause').classList.remove('hidden');

      timerInterval = setInterval(() => {
        if (timerMode === 'stopwatch') {
          timerSeconds++;
        } else {
          countdownRemaining--;
          if (countdownRemaining <= 0) {
            countdownRemaining = 0;
            pauseTimer();
            playAlarm();
          }
        }
        updateTimerDisplay();
      }, 1000);
    }

    function pauseTimer() {
      clearInterval(timerInterval);
      timerInterval = null;
      document.getElementById('btnStart').classList.remove('hidden');
      document.getElementById('btnPause').classList.add('hidden');
    }

    function resetTimer() {
      pauseTimer();
      if (timerMode === 'stopwatch') {
        timerSeconds = 0;
      } else {
        countdownRemaining = countdownTotal;
      }
      document.getElementById('timerContainer').style.background = '#f3f4f6';
      document.getElementById('timerDisplay').style.color = '#111827';
      updateTimerDisplay();
    }

    function playAlarm() {
      if (!document.getElementById('soundEnabled').checked) return;

      // Web Audio API로 알림음 생성
      try {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const playBeep = (freq, start, duration) => {
          const osc = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          osc.connect(gain);
          gain.connect(audioCtx.destination);
          osc.frequency.value = freq;
          osc.type = 'sine';
          gain.gain.setValueAtTime(0.3, audioCtx.currentTime + start);
          gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + start + duration);
          osc.start(audioCtx.currentTime + start);
          osc.stop(audioCtx.currentTime + start + duration);
        };
        // 3연속 비프음
        playBeep(880, 0, 0.2);
        playBeep(880, 0.3, 0.2);
        playBeep(1100, 0.6, 0.4);
      } catch (e) {
        console.log('Audio not supported');
      }

      // 시각적 알림
      alert('⏰ 시간이 종료되었습니다!');
    }

    // 저장 (양쪽 템플릿 모두 저장)
    function saveAnswer() {
      const planEl = document.getElementById('template-plan');
      const problemEl = document.getElementById('template-problem');

      const planAnswers = {};
      planEl.querySelectorAll('textarea').forEach((ta, i) => {
        planAnswers['field_' + i] = ta.value;
      });

      const problemAnswers = {};
      problemEl.querySelectorAll('textarea').forEach((ta, i) => {
        problemAnswers['field_' + i] = ta.value;
      });

      const data = {
        time: document.getElementById('timerDisplay').textContent,
        timerMode: timerMode,
        timerSeconds: timerMode === 'stopwatch' ? timerSeconds : (countdownTotal - countdownRemaining),
        plan: planAnswers,
        problem: problemAnswers,
        savedAt: new Date().toISOString()
      };

      localStorage.setItem('mockTest_' + Date.now(), JSON.stringify(data));
      alert('저장되었습니다!');
    }

    // 불러오기 모달
    function openLoadModal() {
      renderSavedList();
      document.getElementById('loadModal').classList.remove('hidden');
      document.getElementById('loadModal').classList.add('flex');
    }

    function closeLoadModal() {
      document.getElementById('loadModal').classList.add('hidden');
      document.getElementById('loadModal').classList.remove('flex');
    }

    function renderSavedList() {
      const container = document.getElementById('savedList');
      const keys = Object.keys(localStorage).filter(k => k.startsWith('mockTest_')).sort().reverse();

      if (keys.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-8">저장된 답안이 없습니다.</div>';
        return;
      }

      let html = '<div class="space-y-2">';
      keys.forEach(key => {
        const data = JSON.parse(localStorage.getItem(key));
        const date = new Date(data.savedAt);
        const dateStr = date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR');

        const elapsedTime = data.timerSeconds ? formatTime(data.timerSeconds) : data.time;
        html += `
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100">
            <div>
              <div class="font-medium text-gray-900">모의 답안</div>
              <div class="text-xs text-gray-500">${dateStr}</div>
              <div class="text-xs text-indigo-600 font-medium mt-1">⏱ 소요시간: ${elapsedTime}</div>
            </div>
            <div class="flex gap-2">
              <button onclick="loadAnswer('${key}')" class="px-3 py-1.5 bg-indigo-600 text-white rounded text-xs hover:bg-indigo-700">불러오기</button>
              <button onclick="deleteSaved('${key}')" class="px-3 py-1.5 bg-red-100 text-red-700 rounded text-xs hover:bg-red-200">삭제</button>
            </div>
          </div>
        `;
      });
      html += '</div>';
      container.innerHTML = html;
    }

    function loadAnswer(key) {
      const data = JSON.parse(localStorage.getItem(key));
      if (!data) return;

      // 기획안 답안 채우기
      const planEl = document.getElementById('template-plan');
      planEl.querySelectorAll('textarea').forEach((ta, i) => {
        ta.value = (data.plan && data.plan['field_' + i]) || '';
      });

      // 문제점/해결방안 답안 채우기
      const problemEl = document.getElementById('template-problem');
      problemEl.querySelectorAll('textarea').forEach((ta, i) => {
        ta.value = (data.problem && data.problem['field_' + i]) || '';
      });

      // 타이머 설정 (스톱워치 모드로 소요시간 표시)
      setTimerMode('stopwatch');
      const timeParts = data.time.split(':');
      timerSeconds = parseInt(timeParts[0]) * 3600 + parseInt(timeParts[1]) * 60 + parseInt(timeParts[2]);
      updateTimerDisplay();

      closeLoadModal();
      alert('불러왔습니다!');
    }

    function deleteSaved(key) {
      if (confirm('이 답안을 삭제할까요?')) {
        localStorage.removeItem(key);
        renderSavedList();
      }
    }

    function clearAllSaved() {
      if (confirm('모든 저장된 답안을 삭제할까요?')) {
        const keys = Object.keys(localStorage).filter(k => k.startsWith('mockTest_'));
        keys.forEach(k => localStorage.removeItem(k));
        renderSavedList();
      }
    }

    // 자동 서식 기능
    document.addEventListener('DOMContentLoaded', function() {
      // 모든 auto-bullet textarea에 이벤트 리스너 추가
      document.querySelectorAll('.auto-bullet').forEach(textarea => {
        const mainBullet = textarea.dataset.bullet; // ○ 또는 -
        const subBullet = '•'; // 소항목용

        // 포커스 시 빈칸이면 첫 번째 bullet 추가
        textarea.addEventListener('focus', function() {
          if (this.value === '') {
            this.value = mainBullet + ' ';
          }
        });

        textarea.addEventListener('keydown', function(e) {
          const start = this.selectionStart;
          const value = this.value;
          const lines = value.substring(0, start).split('\n');
          const currentLine = lines[lines.length - 1];
          const lineStart = start - currentLine.length;

          // Tab: 소항목으로 전환
          if (e.key === 'Tab' && !e.shiftKey) {
            e.preventDefault();

            // 현재 줄이 대항목(○ 또는 -)으로 시작하면 소항목(  •)으로 변경
            if (currentLine.startsWith(mainBullet + ' ')) {
              const afterBullet = currentLine.substring(2);
              const newLine = '  ' + subBullet + ' ' + afterBullet;
              const before = value.substring(0, lineStart);
              const after = value.substring(start);
              this.value = before + newLine + after;
              this.selectionStart = lineStart + newLine.length;
              this.selectionEnd = lineStart + newLine.length;
            }
            // 빈 대항목이면 소항목으로
            else if (currentLine === mainBullet + ' ') {
              const before = value.substring(0, lineStart);
              const after = value.substring(start);
              this.value = before + '  ' + subBullet + ' ' + after;
              this.selectionStart = lineStart + 5;
              this.selectionEnd = lineStart + 5;
            }
            return;
          }

          // Shift+Tab: 대항목으로 복귀
          if (e.key === 'Tab' && e.shiftKey) {
            e.preventDefault();

            // 현재 줄이 소항목(  •)으로 시작하면 대항목으로 변경
            if (currentLine.startsWith('  ' + subBullet + ' ')) {
              const afterBullet = currentLine.substring(4);
              const newLine = mainBullet + ' ' + afterBullet;
              const before = value.substring(0, lineStart);
              const after = value.substring(start);
              this.value = before + newLine + after;
              this.selectionStart = lineStart + newLine.length;
              this.selectionEnd = lineStart + newLine.length;
            }
            return;
          }

          // Enter: 항상 대항목으로 새 줄
          if (e.key === 'Enter') {
            e.preventDefault();
            const end = this.selectionEnd;
            const newBullet = mainBullet + ' ';

            const newText = value.substring(0, start) + '\n' + newBullet + value.substring(end);
            this.value = newText;
            const newPos = start + 1 + newBullet.length;
            this.selectionStart = newPos;
            this.selectionEnd = newPos;
            return;
          }

          // Backspace: 빈 bullet 줄 삭제 또는 소항목→대항목 전환
          if (e.key === 'Backspace') {
            // 소항목 빈 줄이면 대항목으로
            if (currentLine === '  ' + subBullet + ' ' && lines.length >= 1) {
              e.preventDefault();
              const before = value.substring(0, lineStart);
              const after = value.substring(start);
              this.value = before + mainBullet + ' ' + after;
              this.selectionStart = lineStart + 2;
              this.selectionEnd = lineStart + 2;
              return;
            }

            // 대항목 빈 줄이면 줄 삭제
            if (currentLine === mainBullet + ' ' && lines.length > 1) {
              e.preventDefault();
              const before = value.substring(0, lineStart - 1);
              const after = value.substring(start);
              this.value = before + after;
              this.selectionStart = before.length;
              this.selectionEnd = before.length;
              return;
            }
          }
        });
      });
    });

    // 플로팅 텍스트 툴바
    const toolbar = document.getElementById('textToolbar');
    let currentSelection = null;

    // 콘텐츠 영역에서 텍스트 선택 감지
    document.querySelectorAll('.content-area').forEach(area => {
      area.addEventListener('mouseup', showToolbar);

      // 서식 적용된 요소 클릭 시 자동 선택
      area.addEventListener('click', (e) => {
        const target = e.target;
        if (target.tagName === 'MARK' || target.tagName === 'STRONG' || target.tagName === 'EM') {
          e.stopPropagation();
          // 해당 요소 전체 선택
          const range = document.createRange();
          range.selectNodeContents(target);
          const selection = window.getSelection();
          selection.removeAllRanges();
          selection.addRange(range);
          currentSelection = selection;
          // 툴바 표시
          const rect = target.getBoundingClientRect();
          toolbar.style.left = (rect.left + rect.width / 2) + 'px';
          toolbar.style.top = (rect.top - 45 + window.scrollY) + 'px';
          toolbar.classList.remove('hidden');
        }
      });
    });

    document.addEventListener('mousedown', (e) => {
      if (!toolbar.contains(e.target) && e.target.tagName !== 'MARK' && e.target.tagName !== 'STRONG' && e.target.tagName !== 'EM') {
        toolbar.classList.add('hidden');
      }
    });

    function showToolbar() {
      const selection = window.getSelection();
      if (selection.toString().trim().length > 0) {
        currentSelection = selection;
        const range = selection.getRangeAt(0);
        const rect = range.getBoundingClientRect();

        toolbar.style.left = (rect.left + rect.width / 2) + 'px';
        toolbar.style.top = (rect.top - 45 + window.scrollY) + 'px';
        toolbar.classList.remove('hidden');
      }
    }

    function applyHighlight(color) {
      if (!currentSelection || currentSelection.toString().trim().length === 0) return;

      const range = currentSelection.getRangeAt(0);
      const selectedText = range.toString();

      const wrapper = document.createElement('mark');
      wrapper.style.backgroundColor = color;
      wrapper.style.padding = '0 2px';
      wrapper.style.borderRadius = '2px';

      try {
        range.surroundContents(wrapper);
      } catch (e) {
        wrapper.textContent = selectedText;
        range.deleteContents();
        range.insertNode(wrapper);
      }

      toolbar.classList.add('hidden');
      window.getSelection().removeAllRanges();
    }

    function applyFormat(type) {
      if (!currentSelection || currentSelection.toString().trim().length === 0) return;

      const range = currentSelection.getRangeAt(0);
      const selectedText = range.toString();

      // 현재 선택 영역의 부모 요소들 확인
      let node = range.commonAncestorContainer;
      if (node.nodeType === 3) node = node.parentElement;

      const tagMap = { bold: 'STRONG', italic: 'EM' };
      const targetTag = tagMap[type];

      // 해당 서식이 이미 적용되어 있는지 확인
      function findParentTag(el, tag) {
        while (el && el.classList && !el.classList.contains('content-area')) {
          if (el.tagName === tag) return el;
          el = el.parentElement;
        }
        return null;
      }

      if (type === 'bold' || type === 'italic') {
        const existingTag = findParentTag(node, targetTag);

        if (existingTag) {
          // 서식 제거 (토글 off)
          const parent = existingTag.parentNode;
          while (existingTag.firstChild) {
            parent.insertBefore(existingTag.firstChild, existingTag);
          }
          parent.removeChild(existingTag);
          toolbar.classList.add('hidden');
          window.getSelection().removeAllRanges();
          return;
        }

        // 서식 적용
        const wrapper = document.createElement(targetTag === 'STRONG' ? 'strong' : 'em');
        try {
          range.surroundContents(wrapper);
        } catch (e) {
          wrapper.textContent = selectedText;
          range.deleteContents();
          range.insertNode(wrapper);
        }
      } else if (type === 'remove') {
        // 모든 서식 제거
        const tagsToRemove = ['MARK', 'STRONG', 'EM'];
        for (const tag of tagsToRemove) {
          const found = findParentTag(node, tag);
          if (found) {
            const parent = found.parentNode;
            while (found.firstChild) {
              parent.insertBefore(found.firstChild, found);
            }
            parent.removeChild(found);
          }
        }
      }

      toolbar.classList.add('hidden');
      window.getSelection().removeAllRanges();
    }

    // 답안 자동저장 (30초마다)
    let autoSaveInterval = null;

    function startAutoSave() {
      if (autoSaveInterval) return;
      autoSaveInterval = setInterval(() => {
        const planEl = document.getElementById('template-plan');
        const problemEl = document.getElementById('template-problem');

        const hasContent = [...planEl.querySelectorAll('textarea'), ...problemEl.querySelectorAll('textarea')]
          .some(ta => ta.value.trim().length > 0);

        if (hasContent) {
          const planAnswers = {};
          planEl.querySelectorAll('textarea').forEach((ta, i) => {
            planAnswers['field_' + i] = ta.value;
          });
          const problemAnswers = {};
          problemEl.querySelectorAll('textarea').forEach((ta, i) => {
            problemAnswers['field_' + i] = ta.value;
          });

          localStorage.setItem('mockTest_autosave', JSON.stringify({
            time: document.getElementById('timerDisplay').textContent,
            plan: planAnswers,
            problem: problemAnswers,
            savedAt: new Date().toISOString()
          }));

          // 자동저장 표시
          const indicator = document.getElementById('autoSaveIndicator');
          if (indicator) {
            indicator.textContent = '자동저장됨';
            indicator.classList.remove('opacity-0');
            setTimeout(() => indicator.classList.add('opacity-0'), 2000);
          }
        }
      }, 30000);
    }

    function stopAutoSave() {
      if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
        autoSaveInterval = null;
      }
    }

    function loadAutoSave() {
      const data = localStorage.getItem('mockTest_autosave');
      if (data) {
        const parsed = JSON.parse(data);
        const savedTime = new Date(parsed.savedAt);
        const now = new Date();
        const diffMin = Math.floor((now - savedTime) / 60000);

        if (diffMin < 60 && confirm(`${diffMin}분 전 자동저장된 답안이 있습니다. 불러올까요?`)) {
          const planEl = document.getElementById('template-plan');
          planEl.querySelectorAll('textarea').forEach((ta, i) => {
            ta.value = (parsed.plan && parsed.plan['field_' + i]) || '';
            updateCharCount(ta);
          });
          const problemEl = document.getElementById('template-problem');
          problemEl.querySelectorAll('textarea').forEach((ta, i) => {
            ta.value = (parsed.problem && parsed.problem['field_' + i]) || '';
            updateCharCount(ta);
          });
        }
      }
    }

    // 글자 수 카운터
    function updateCharCount(textarea) {
      const counter = textarea.parentElement.querySelector('.char-counter');
      if (counter) {
        const text = textarea.value;
        const chars = text.length;
        const lines = text.split('\n').filter(l => l.trim()).length;
        counter.textContent = `${chars}자 / ${lines}줄`;
      }
    }

    // Word 내보내기
    function exportWord() {
      const now = new Date();
      const dateStr = now.toLocaleDateString('ko-KR');
      const timeStr = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
      const elapsed = document.getElementById('timerDisplay').textContent;

      // 기획안 데이터 수집
      const planEl = document.getElementById('template-plan');
      const planTextareas = planEl.querySelectorAll('textarea');
      const planLabels = ['사업 개요', '추진 배경', '추진 목적', '문제점', '해결방안', '사업 내용'];

      // 문제점/해결방안 데이터 수집
      const problemEl = document.getElementById('template-problem');
      const problemTextareas = problemEl.querySelectorAll('textarea');
      const problemLabels = ['현황', '문제점', '해결방안'];

      // 텍스트를 HTML로 변환
      function textToHtml(text) {
        if (!text || text.trim() === '') return '';
        return text.split('\n').filter(line => line.trim()).map(line => {
          const isSubItem = line.trim().startsWith('•');
          return `<p style="margin:2px 0; ${isSubItem ? 'margin-left:15px;' : ''}">${line}</p>`;
        }).join('');
      }

      // HTML 문서 생성 (좁게 여백: 1.27cm = 720 twips)
      const html = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
        <head>
          <meta charset="utf-8">
          <!--[if gte mso 9]>
          <xml>
            <w:WordDocument>
              <w:View>Print</w:View>
            </w:WordDocument>
          </xml>
          <xml>
            <w:Section>
              <w:TopMargin>720</w:TopMargin>
              <w:BottomMargin>720</w:BottomMargin>
              <w:LeftMargin>720</w:LeftMargin>
              <w:RightMargin>720</w:RightMargin>
            </w:Section>
          </xml>
          <![endif]-->
          <style>
            @page { margin: 1.27cm; }
            body { font-family: '맑은 고딕', 'Malgun Gothic', sans-serif; font-size: 10pt; line-height: 1.4; }
            h1 { text-align: center; font-size: 14pt; margin: 0 0 5px 0; }
            .meta { text-align: center; color: #666; font-size: 9pt; margin-bottom: 15px; }
            .section { font-weight: bold; font-size: 11pt; border-bottom: 1px solid #5b21b6; color: #5b21b6; padding-bottom: 3px; margin: 15px 0 8px 0; }
            .section2 { border-color: #1d4ed8; color: #1d4ed8; }
            .item { margin-bottom: 8px; }
            .item-title { font-weight: bold; }
            .item-content { margin-left: 12px; }
          </style>
        </head>
        <body>
          <h1>KHIDI 인바스켓 모의 답안</h1>
          <p class="meta">${dateStr} ${timeStr} · 소요시간: ${elapsed}</p>

          <div class="section">★ 기획안</div>
          ${planLabels.map((label, i) => {
            const content = textToHtml(planTextareas[i]?.value);
            if (!content) return '';
            return `<div class="item"><span class="item-title">◎ ${label}</span><div class="item-content">${content}</div></div>`;
          }).join('')}

          <div class="section section2">★ 문제점 및 해결방안</div>
          ${problemLabels.map((label, i) => {
            const content = textToHtml(problemTextareas[i]?.value);
            if (!content) return '';
            return `<div class="item"><span class="item-title">◎ ${label}</span><div class="item-content">${content}</div></div>`;
          }).join('')}
        </body>
        </html>
      `;

      // Blob 생성 및 다운로드
      const blob = new Blob(['\ufeff' + html], { type: 'application/msword' });
      const filename = `KHIDI_모의답안_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.doc`;

      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      URL.revokeObjectURL(link.href);
    }
  </script>
</body>
</html>
